#!/bin/bash

IMAGE_NAME="redis_cve_2023_45145"

function invalid_flag() {
  echo "Error: Invalid flag '$1'"
  echo "Usage: $0 (brun | build | run | enter | verify | stop | kill | logs)"
  exit 1
}

case "$1" in
  brun)
    echo "Building + Runnning Docker image..."
    docker build -t "$IMAGE_NAME" -f Dockerfile.redis_cve_2023_45145 .
    docker run -d --name "$IMAGE_NAME" "$IMAGE_NAME"
    ;;
  build)
    echo "Building Docker image..."
    docker build -t "$IMAGE_NAME" -f Dockerfile.redis_cve_2023_45145 .
    ;;
  run)
    echo "Running the container in detached mode..."
    docker run -d --name "$IMAGE_NAME" "$IMAGE_NAME"
    ;;
  enter)
    echo "Entering the container..."
    docker exec -it "$IMAGE_NAME" /bin/sh
    ;;
  verify)
    echo "Verifying Redis server..."
    docker exec -it "$IMAGE_NAME" redis-cli ping
    ;;
  stop)
    echo "Stopping the container..."
    docker stop "$IMAGE_NAME"
    ;;
  kill)
    echo "Stopping and removing the container..."
    docker stop "$IMAGE_NAME"
    docker rm "$IMAGE_NAME"
    ;;
  logs)
    echo "Printing logs:....."
    docker exec -it "$IMAGE_NAME" cat /tmp/exploit.log
    ;;
  *)
    invalid_flag "$1"
    ;;
esac

exit 0
